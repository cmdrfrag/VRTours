<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>C-HQ Arcade VR Tour</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <style>
    body { margin: 0; background: black; }

    #startButton, #minimap {
      position: fixed;
      z-index: 2;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      padding: 12px 20px;
      font-size: 18px;
      cursor: pointer;
    }
    #startButton {
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
    }
    #minimap {
      top: 20px; left: 20px;
      display: none;
    }
    #minimap button {
      display: block;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <!-- Video element -->
  <video id="video360"
         crossorigin="anonymous"
         loop
         playsinline webkit-playsinline
         preload="auto"
         style="display:none;"></video>

  <!-- Minimap -->
  <div id="minimap">
      <button onclick="setScene('https://pub-01ff401aa37f4e2e9507a82aaa0d3e35.r2.dev/video1.mp4')">Scene 1</button>
      <button onclick="setScene('https://pub-01ff401aa37f4e2e9507a82aaa0d3e35.r2.dev/video2.mp4')">Scene 2</button>
      <button onclick="setScene('https://pub-01ff401aa37f4e2e9507a82aaa0d3e35.r2.dev/video3.mp4')">Scene 3</button>
  </div>

  <!-- Start Button -->
  <button id="startButton">Enter Experience</button>

  <!-- Fade Overlay -->
  <div id="fadeOverlay" style="
    position:fixed; top:0; left:0; right:0; bottom:0;
    background:black; z-index:3;
    opacity:0; transition:opacity 1s;
    pointer-events:none;">
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" style="
    position:fixed; top:0; left:0; right:0; bottom:0;
    display:flex; align-items:center; justify-content:center;
    background:black; color:white; font-size:24px; font-family:sans-serif;
    z-index:4; opacity:0; transition:opacity 0.3s; pointer-events:none;">
    Loadingâ€¦
  </div>

  <!-- A-Frame Scene -->
  <a-scene vr-mode-ui="enabled: true">
    <a-entity id="videosphere-container"></a-entity>

    <!-- Camera + dual-ring fuse cursor -->
    <a-entity camera look-controls position="0 1.6 0">
      <a-entity id="cursor" position="0 0 -1"
                cursor="fuse: true; fuseTimeout: 2000">
        <!-- Outer ring (static) -->
        <a-entity
          geometry="primitive: ring; radiusInner: 0.018; radiusOuter: 0.025"
          material="color: white; shader: flat">
        </a-entity>

        <!-- Inner ring (progress fill) -->
        <a-entity id="cursor-progress"
          geometry="primitive: ring; radiusInner: 0.018; radiusOuter: 0.025"
          material="color: yellow; shader: flat; opacity: 0.7"
          scale="0 1 1">
        </a-entity>
      </a-entity>
    </a-entity>

    <!-- Hotspots -->
    <a-entity id="toScene2"
      geometry="primitive: sphere; radius: 0.3"
      material="color: green; opacity: 0.5; transparent: true"
      position="0 1 -3"
      visible="false"></a-entity>

    <a-entity id="toScene3"
      geometry="primitive: sphere; radius: 0.3"
      material="color: blue; opacity: 0.5; transparent: true"
      position="1 1 -3"
      visible="false"></a-entity>
  </a-scene>

  <script>
    const startButton = document.getElementById("startButton");
    const minimap = document.getElementById("minimap");
    const videoEl = document.getElementById("video360");
    const sphereContainer = document.getElementById("videosphere-container");
    const fadeOverlay = document.getElementById("fadeOverlay");
    const loadingOverlay = document.getElementById("loadingOverlay");

    const toScene2 = document.getElementById("toScene2");
    const toScene3 = document.getElementById("toScene3");

      let currentScene = "https://pub-01ff401aa37f4e2e9507a82aaa0d3e35.r2.dev/video1.mp4";

      const scenes = {
        "https://pub-01ff401aa37f4e2e9507a82aaa0d3e35.r2.dev/video1.mp4": [
          { target: "https://pub-01ff401aa37f4e2e9507a82aaa0d3e35.r2.dev/video2.mp4", position: "-4 1 -4", color: "green" },
          { target: "https://pub-01ff401aa37f4e2e9507a82aaa0d3e35.r2.dev/video3.mp4", position: "3 1 -1", color: "blue" }
        ],
        "https://pub-01ff401aa37f4e2e9507a82aaa0d3e35.r2.dev/video2.mp4": [
          { target: "https://pub-01ff401aa37f4e2e9507a82aaa0d3e35.r2.dev/video1.mp4", position: "0.5 1 -4", color: "red" },
          { target: "https://pub-01ff401aa37f4e2e9507a82aaa0d3e35.r2.dev/video3.mp4", position: "-2 1 -4", color: "blue" }
        ],
        "https://pub-01ff401aa37f4e2e9507a82aaa0d3e35.r2.dev/video3.mp4": [
          { target: "https://pub-01ff401aa37f4e2e9507a82aaa0d3e35.r2.dev/video1.mp4", position: "-5 1 -1.5", color: "red" },
          { target: "https://pub-01ff401aa37f4e2e9507a82aaa0d3e35.r2.dev/video2.mp4", position: "-2 1 -6", color: "green" }
        ]
      };

    // Start experience
    startButton.addEventListener("click", () => {
      videoEl.src = currentScene;
      videoEl.load();
      videoEl.play().then(() => {
        startButton.style.display = "none";
        minimap.style.display = "block";
        setScene(currentScene);
      });
    });

    // Transition handler
    function fadeTransition(callback) {
      fadeOverlay.style.opacity = "1";
      setTimeout(() => {
        callback();
        fadeOverlay.style.opacity = "0";
      }, 1000);
    }

    // Scene switching
    function setScene(sceneName) {
      currentScene = sceneName;
      fadeTransition(() => {
        videoEl.pause();
        videoEl.src = sceneName;
        videoEl.load();

        // Hide sphere while loading
        const oldSphere = document.getElementById("sphere");
        if (oldSphere) oldSphere.setAttribute("visible", false);

        // ðŸ”¹ Show loading overlay
        loadingOverlay.style.opacity = "1";

        videoEl.onloadeddata = () => {
          videoEl.play().then(() => {
            // Recreate sphere to bind new texture
            if (oldSphere) oldSphere.parentNode.removeChild(oldSphere);
            const newSphere = document.createElement("a-videosphere");
            newSphere.setAttribute("id", "sphere");
            newSphere.setAttribute("src", "#video360");
            newSphere.setAttribute("rotation", "0 90 0");
            newSphere.setAttribute("material",
              "shader: flat; npot: true; magFilter: linear; minFilter: linear;");
            sphereContainer.appendChild(newSphere);

            updateHotspots(sceneName);

            // ðŸ”¹ Hide loading overlay once ready
            loadingOverlay.style.opacity = "0";
          }).catch(err => {
            console.error("Playback failed:", err);
            loadingOverlay.style.opacity = "0"; // fallback hide
          });
        };
      });
    }

    // Hotspot updates
    function updateHotspots(sceneName) {
      const hotspotDefs = scenes[sceneName];
      const hotspotEls = [toScene2, toScene3];

      hotspotEls.forEach((el, i) => {
        const { target, position, color } = hotspotDefs[i];

        el.setAttribute("position", position);
        el.setAttribute("material",
          `color: ${color}; opacity: 0.5; transparent: true`);
        el.setAttribute("visible", true);
        el.classList.add("hotspot");

        if (el.handler) el.removeEventListener("click", el.handler);
        el.handler = () => setScene(target);
        el.addEventListener("click", el.handler);

        // Cursor fuse progress animation only on hotspot gaze
        el.addEventListener("fusing", () => {
          const progress = document.getElementById("cursor-progress");
          progress.setAttribute("animation__fuse", {
            property: "scale",
            from: "0 1 1",
            to: "1 1 1",
            dur: 2000,
            easing: "linear"
          });
        });

        el.addEventListener("mouseleave", () => {
          const progress = document.getElementById("cursor-progress");
          progress.removeAttribute("animation__fuse");
          progress.setAttribute("scale", "0 1 1"); // reset
        });
      });
    }
  </script>
</body>
</html>
